# Database р╣Бр╕ер╕░ Scripts Documentation

р╣Ар╕нр╕Бр╕кр╕▓р╕гр╕Ыр╕гр╕░р╕Бр╕нр╕Ър╕кр╕│р╕лр╕гр╕▒р╕Ър╕Бр╕▓р╕гр╕Ир╕▒р╕Фр╕Бр╕▓р╕гр╕Рр╕▓р╕Щр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Бр╕ер╕░ database scripts

## ЁЯУЛ р╕ар╕▓р╕Юр╕гр╕зр╕б

р╣Вр╕Ыр╕гр╣Ар╕Ир╕Бр╕Хр╣Мр╕Щр╕╡р╣Йр╣Гр╕Кр╣Й Supabase (PostgreSQL) р╣Ар╕Ыр╣Зр╕Щр╕Рр╕▓р╕Щр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕лр╕ер╕▒р╕Б р╕Юр╕гр╣Йр╕нр╕бр╕Фр╣Йр╕зр╕в scripts р╕Чр╕╡р╣Ир╣Др╕Фр╣Йр╕гр╕▒р╕Ър╕Бр╕▓р╕гр╕Ир╕▒р╕Фр╕гр╕░р╣Ар╕Ър╕╡р╕вр╕Ър╣Гр╕лр╕бр╣Ир╣Ар╕Юр╕╖р╣Ир╕нр╕Др╕зр╕▓р╕бр╕Зр╣Ир╕▓р╕вр╣Гр╕Щр╕Бр╕▓р╕гр╕Ир╕▒р╕Фр╕Бр╕▓р╕г

## ЁЯУЪ р╣Ар╕нр╕Бр╕кр╕▓р╕гр╣Гр╕Щр╕лр╕бр╕зр╕Фр╕Щр╕╡р╣Й

### ЁЯФз Scripts р╣Бр╕ер╕░р╕Бр╕▓р╕гр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щ
- [Database Scripts Overview](../../scripts/README.md) - р╕ар╕▓р╕Юр╕гр╕зр╕б scripts р╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф
- [Consolidated Scripts Usage Guide](./CONSOLIDATED_SCRIPTS_USAGE.md) - р╕Др╕╣р╣Ир╕бр╕╖р╕нр╕Бр╕▓р╕гр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щр╣Бр╕Ър╕Ър╕ер╕░р╣Ар╕нр╕╡р╕вр╕Ф
- [Migration Guide](./MIGRATION_GUIDE.md) - р╕Др╕╣р╣Ир╕бр╕╖р╕нр╕Бр╕▓р╕гр╕вр╣Йр╕▓р╕вр╕Ир╕▓р╕Б scripts р╣Ар╕Бр╣Ир╕▓р╣Др╕Ыр╣Гр╕лр╕бр╣И

### ЁЯЧДя╕П Migrations
- [Migrations Overview](../../supabase/migrations/README.md) - р╕ар╕▓р╕Юр╕гр╕зр╕б database migrations
- [Migration Files](../../supabase/migrations/) - р╣Др╕Яр╕ер╣М migration р╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф

### ЁЯзк р╕Бр╕▓р╕гр╕Чр╕Фр╕кр╕нр╕Ъ
- [Scripts Validation Tests](../../tests/scripts/README.md) - р╕Бр╕▓р╕гр╕Чр╕Фр╕кр╕нр╕Ъ scripts
- [Test Files](../../tests/scripts/) - р╣Др╕Яр╕ер╣Мр╕Чр╕Фр╕кр╕нр╕Ър╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф

## ЁЯЪА р╣Ар╕гр╕┤р╣Ир╕бр╕Хр╣Йр╕Щр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щ

### р╕кр╕│р╕лр╕гр╕▒р╕Ър╕Щр╕▒р╕Бр╕Юр╕▒р╕Тр╕Щр╕▓р╣Гр╕лр╕бр╣И

1. **р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓р╕кр╕ар╕▓р╕Юр╣Бр╕зр╕Фр╕ер╣Йр╕нр╕бр╕Бр╕▓р╕гр╕Юр╕▒р╕Тр╕Щр╕▓:**
   ```bash
   ./scripts/development-setup.sh
   ```

2. **р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓ admin user:**
   ```sql
   -- р╕гр╕▒р╕Щр╣Гр╕Щ Supabase SQL Editor
   \i scripts/admin-management.sql
   SELECT public.promote_to_admin('your-email@example.com');
   ```

3. **р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕кр╕Цр╕▓р╕Щр╕░р╕Рр╕▓р╕Щр╕Вр╣Йр╕нр╕бр╕╣р╕е:**
   ```bash
   node scripts/database-utilities.js all
   ```

### р╕кр╕│р╕лр╕гр╕▒р╕Ър╣Вр╕Ыр╕гр╣Ар╕Ир╕Бр╕Хр╣Мр╕Чр╕╡р╣Ир╕бр╕╡р╕нр╕вр╕╣р╣Ир╣Бр╕ер╣Йр╕з

р╕лр╕▓р╕Бр╕Др╕╕р╕Ур╕бр╕╡ database scripts р╣Бр╕Ър╕Ър╣Ар╕Бр╣Ир╕▓ р╣Гр╕лр╣Йр╕Фр╕╣ [Migration Guide](./MIGRATION_GUIDE.md)

## ЁЯУЦ Scripts р╕лр╕ер╕▒р╕Б

### 1. Admin Management (`admin-management.sql`)
р╕Ир╕▒р╕Фр╕Бр╕▓р╕гр╕Ьр╕╣р╣Йр╣Гр╕Кр╣Й admin р╣Бр╕ер╕░р╕кр╕┤р╕Чр╕Шр╕┤р╣Мр╕Бр╕▓р╕гр╣Ар╕Вр╣Йр╕▓р╕Цр╕╢р╕З

**р╕Яр╕▒р╕Зр╕Бр╣Мр╕Кр╕▒р╕Щр╕лр╕ер╕▒р╕Б:**
- `promote_to_admin(email)` - р╣Ар╕ер╕╖р╣Ир╕нр╕Щр╕Вр╕▒р╣Йр╕Щр╣Ар╕Ыр╣Зр╕Щ admin
- `list_all_admins()` - р╣Бр╕кр╕Фр╕Зр╕гр╕▓р╕вр╕Кр╕╖р╣Ир╕н admin р╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф
- `check_user_role(email)` - р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕кр╕┤р╕Чр╕Шр╕┤р╣Мр╕Ьр╕╣р╣Йр╣Гр╕Кр╣Й

### 2. Database Utilities (`database-utilities.js`)
р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕кр╕╕р╕Вр╕ар╕▓р╕Юр╕Рр╕▓р╕Щр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Бр╕ер╕░р╕Ър╕│р╕гр╕╕р╕Зр╕гр╕▒р╕Бр╕йр╕▓

**р╕Др╕│р╕кр╕▒р╣Ир╕Зр╕лр╕ер╕▒р╕Б:**
```bash
node scripts/database-utilities.js check     # р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕кр╕╕р╕Вр╕ар╕▓р╕Ю
node scripts/database-utilities.js partners # р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ partner roles
node scripts/database-utilities.js slugs    # р╕нр╕▒р╕Юр╣Ар╕Фр╕Ч gym slugs
node scripts/database-utilities.js all      # р╕гр╕▒р╕Щр╕Чр╕╕р╕Бр╕нр╕вр╣Ир╕▓р╕З
```

### 3. Development Setup (`development-setup.sh`)
р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓р╕кр╕ар╕▓р╕Юр╣Бр╕зр╕Фр╕ер╣Йр╕нр╕бр╕Бр╕▓р╕гр╕Юр╕▒р╕Тр╕Щр╕▓

**р╕Хр╕▒р╕зр╣Ар╕ер╕╖р╕нр╕Б:**
```bash
./scripts/development-setup.sh              # р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓р╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф
./scripts/development-setup.sh --users-only # р╕кр╕гр╣Йр╕▓р╕З test users р╣Ар╕Чр╣Ир╕▓р╕Щр╕▒р╣Йр╕Щ
./scripts/development-setup.sh --check-only # р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕кр╕ар╕▓р╕Юр╣Бр╕зр╕Фр╕ер╣Йр╕нр╕б
```

### 4. Storage Configuration (`storage-configuration.sql`)
р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓ storage buckets р╣Бр╕ер╕░ policies

**р╕Яр╕╡р╣Ар╕Ир╕нр╕гр╣М:**
- р╕кр╕гр╣Йр╕▓р╕З gym-images bucket
- р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓ access policies
- р╕Яр╕▒р╕Зр╕Бр╣Мр╕Кр╕▒р╕Щр╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕кр╕╕р╕Вр╕ар╕▓р╕Ю storage

## ЁЯФД Database Schema

### р╕Хр╕▓р╕гр╕▓р╕Зр╕лр╕ер╕▒р╕Б

| р╕Хр╕▓р╕гр╕▓р╕З | р╕зр╕▒р╕Хр╕Цр╕╕р╕Ыр╕гр╕░р╕кр╕Зр╕Др╣М | р╕Др╕зр╕▓р╕бр╕кр╕▒р╕бр╕Юр╕▒р╕Щр╕Шр╣М |
|-------|-------------|-------------|
| `profiles` | р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Ьр╕╣р╣Йр╣Гр╕Кр╣Й | р╣Ар╕Кр╕╖р╣Ир╕нр╕бр╕Бр╕▒р╕Ъ `auth.users` |
| `user_roles` | р╕кр╕┤р╕Чр╕Шр╕┤р╣Мр╕Ьр╕╣р╣Йр╣Гр╕Кр╣Й | р╣Ар╕Кр╕╖р╣Ир╕нр╕бр╕Бр╕▒р╕Ъ `profiles` |
| `gyms` | р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Др╣Ир╕▓р╕вр╕бр╕зр╕в | р╣Ар╕Кр╕╖р╣Ир╕нр╕бр╕Бр╕▒р╕Ъ `profiles` (owner) |
| `gym_packages` | р╣Бр╕Юр╣Зр╕Др╣Ар╕Бр╕Ир╕Др╣Ир╕▓р╕вр╕бр╕зр╕в | р╣Ар╕Кр╕╖р╣Ир╕нр╕бр╕Бр╕▒р╕Ъ `gyms` |
| `bookings` | р╕Бр╕▓р╕гр╕Ир╕нр╕З | р╣Ар╕Кр╕╖р╣Ир╕нр╕бр╕Бр╕▒р╕Ъ `profiles` р╣Бр╕ер╕░ `gym_packages` |
| `payments` | р╕Бр╕▓р╕гр╕Кр╕│р╕гр╕░р╣Ар╕Зр╕┤р╕Щ | р╣Ар╕Кр╕╖р╣Ир╕нр╕бр╕Бр╕▒р╕Ъ `bookings` |

### р╕кр╕┤р╕Чр╕Шр╕┤р╣Мр╕Бр╕▓р╕гр╣Ар╕Вр╣Йр╕▓р╕Цр╕╢р╕З (RLS)

- **User**: р╣Ар╕Вр╣Йр╕▓р╕Цр╕╢р╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Вр╕нр╕Зр╕Хр╕Щр╣Ар╕нр╕Зр╣Бр╕ер╕░р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕кр╕▓р╕Шр╕▓р╕гр╕Ур╕░
- **Partner**: р╕Ир╕▒р╕Фр╕Бр╕▓р╕гр╕Др╣Ир╕▓р╕вр╕бр╕зр╕вр╕Вр╕нр╕Зр╕Хр╕Щр╣Ар╕нр╕З
- **Admin**: р╣Ар╕Вр╣Йр╕▓р╕Цр╕╢р╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф

## ЁЯЫая╕П р╕Бр╕▓р╕гр╕Ър╕│р╕гр╕╕р╕Зр╕гр╕▒р╕Бр╕йр╕▓

### р╕Бр╕▓р╕гр╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Ыр╕гр╕░р╕Ир╕│

```bash
# р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕кр╕╕р╕Вр╕ар╕▓р╕Юр╕Рр╕▓р╕Щр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕гр╕▓р╕вр╕зр╕▒р╕Щ
node scripts/database-utilities.js check

# р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ partner roles р╕гр╕▓р╕вр╕кр╕▒р╕Ыр╕Фр╕▓р╕лр╣М
node scripts/database-utilities.js partners

# р╕нр╕▒р╕Юр╣Ар╕Фр╕Ч gym slugs р╣Ар╕бр╕╖р╣Ир╕нр╕Ир╕│р╣Ар╕Ыр╣Зр╕Щ
node scripts/database-utilities.js slugs
```

### р╕Бр╕▓р╕гр╕кр╕│р╕гр╕нр╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕е

```bash
# р╕кр╕│р╕гр╕нр╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Чр╣Йр╕нр╕Зр╕Цр╕┤р╣Ир╕Щ
supabase db dump --local > backup_$(date +%Y%m%d).sql

# р╕кр╕│р╕гр╕нр╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕е production
supabase db dump > production_backup_$(date +%Y%m%d).sql
```

## ЁЯЪи р╕Бр╕▓р╕гр╣Бр╕Бр╣Йр╣Др╕Вр╕Ыр╕▒р╕Нр╕лр╕▓

### р╕Ыр╕▒р╕Нр╕лр╕▓р╕Чр╕╡р╣Ир╕Юр╕Ър╕Ър╣Ир╕нр╕в

1. **р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╣Ар╕Кр╕╖р╣Ир╕нр╕бр╕Хр╣Ир╕нр╕Рр╕▓р╕Щр╕Вр╣Йр╕нр╕бр╕╣р╕е**
   ```bash
   # р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕кр╕Цр╕▓р╕Щр╕░ Supabase
   supabase status
   
   # р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ environment variables
   echo $SUPABASE_URL
   echo $SUPABASE_ANON_KEY
   ```

2. **Permission denied errors**
   ```sql
   -- р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ RLS policies
   SELECT * FROM pg_policies WHERE tablename = 'table_name';
   
   -- р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕кр╕┤р╕Чр╕Шр╕┤р╣Мр╕Ьр╕╣р╣Йр╣Гр╕Кр╣Й
   SELECT * FROM public.check_user_role('user@example.com');
   ```

3. **Storage bucket р╣Др╕бр╣Ир╕Юр╕Ъ**
   ```sql
   -- р╕гр╕▒р╕Щ storage configuration
   \i scripts/storage-configuration.sql
   
   -- р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ bucket
   SELECT * FROM check_storage_bucket_health();
   ```

### р╕Др╕│р╕кр╕▒р╣Ир╕Зр╕Кр╣Ир╕зр╕вр╣Бр╕Бр╣Йр╣Др╕Вр╕Ыр╕▒р╕Нр╕лр╕▓

```bash
# р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ environment
./scripts/development-setup.sh --check-only

# р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Рр╕▓р╕Щр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Бр╕Ър╕Ър╕ер╕░р╣Ар╕нр╕╡р╕вр╕Ф
node scripts/database-utilities.js all

# р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ migrations
supabase migration list
```

## ЁЯУЮ р╕Бр╕▓р╕гр╕кр╕Щр╕▒р╕Ър╕кр╕Щр╕╕р╕Щ

р╕лр╕▓р╕Бр╕Юр╕Ър╕Ыр╕▒р╕Нр╕лр╕▓р╕лр╕гр╕╖р╕нр╕бр╕╡р╕Др╕│р╕Цр╕▓р╕б:

1. р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ [Troubleshooting Guide](./CONSOLIDATED_SCRIPTS_USAGE.md#troubleshooting-guide)
2. р╕гр╕▒р╕Щр╕Др╕│р╕кр╕▒р╣Ир╕Зр╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕кр╕╕р╕Вр╕ар╕▓р╕Ю: `node scripts/database-utilities.js check`
3. р╕Фр╕╣ [Migration Guide](./MIGRATION_GUIDE.md) р╕лр╕▓р╕Бр╣Ар╕Ыр╣Зр╕Щр╕Ыр╕▒р╕Нр╕лр╕▓р╕Бр╕▓р╕гр╕вр╣Йр╕▓р╕вр╕Вр╣Йр╕нр╕бр╕╣р╕е
4. р╕Хр╕┤р╕Фр╕Хр╣Ир╕нр╕Чр╕╡р╕бр╕Юр╕▒р╕Тр╕Щр╕▓р╕Юр╕гр╣Йр╕нр╕бр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕б error р╕Чр╕╡р╣Ир╕Кр╕▒р╕Фр╣Ар╕Ир╕Щ

## ЁЯФТ р╕Др╕зр╕▓р╕бр╕Ыр╕ер╕нр╕Фр╕ар╕▒р╕в

- р╣Гр╕Кр╣Й service role key р╕кр╕│р╕лр╕гр╕▒р╕Ър╕Бр╕▓р╕гр╕Фр╕│р╣Ар╕Щр╕┤р╕Щр╕Бр╕▓р╕г admin
- р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ admin users р╣Ар╕Ыр╣Зр╕Щр╕Ыр╕гр╕░р╕Ир╕│
- р╣Ар╕Бр╣Зр╕Ъ environment variables р╣Гр╕лр╣Йр╕Ыр╕ер╕нр╕Фр╕ар╕▒р╕в
- р╕Хр╕┤р╕Фр╕Хр╕▓р╕б storage access patterns
- р╕кр╕│р╕гр╕нр╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Ар╕Ыр╣Зр╕Щр╕Ыр╕гр╕░р╕Ир╕│